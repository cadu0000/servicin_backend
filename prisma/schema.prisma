datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  INDIVIDUAL
  COMPANY
}

enum ContactType {
  EMAIL
  PHONE
}

enum AppointmentStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELED
  COMPLETED
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  CASH
  PIX
}

model User {
  id        String    @id @default(uuid()) @db.Uuid
  email     String    @unique
  password  String
  createdAt DateTime  @default(now()) @map("created_at")
  userType  UserRole  @map("user_type")
  photoUrl  String?   @map("photo_url") @db.Text
  deletedAt DateTime? @map("deleted_at")

  address              Address[]
  individual           Individual?
  company              Company?
  serviceProvider      ServiceProvider?
  contacts             Contact[]
  reviewsWritten       Review[]         @relation("ClientReviews")
  appointmentsAsClient Appointment[]    @relation("ClientAppointments")

  @@map("users")
}

model Address {
  id           String  @id @default(uuid()) @db.Uuid
  userId       String  @map("user_id") @db.Uuid
  country      String
  state        String
  city         String
  neighborhood String
  street       String
  zipCode      String  @map("zip_code")
  number       String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("address")
}

model Individual {
  userId    String    @id @map("user_id") @db.Uuid
  fullName  String    @map("full_name")
  cpf       String    @unique
  birthDate DateTime? @map("birth_date") @db.Date

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("individuals")
}

model Company {
  userId        String  @id @map("user_id") @db.Uuid
  corporateName String  @map("corporate_name")
  cnpj          String  @unique
  tradeName     String? @map("trade_name")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("companies")
}

model ServiceProvider {
  userId        String  @id @map("user_id") @db.Uuid
  averageRating Decimal @default(0.00) @map("average_rating") @db.Decimal(3, 2)

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewsReceived Review[]  @relation("ProviderReviews")
  services        Service[]

  @@map("service_providers")
}

model ServiceAvailability {
  id           String   @id @default(uuid()) @db.Uuid
  dayOfWeek    Int      @map("day_of_week")
  startTime    String   @map("start_time")
  endTime      String   @map("end_time")
  breakStart   String?  @map("break_start")
  breakEnd     String?  @map("break_end")
  slotDuration Int      @default(30) @map("slot_duration")
  service      Service? @relation(fields: [serviceId], references: [id])
  serviceId    String?  @db.Uuid

  @@unique([serviceId, dayOfWeek])
  @@map("service_availabilities")
}

model Category {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String? @db.Text

  services Service[]

  @@map("categories")
}

model Service {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique
  description String?  @db.Text
  price       Decimal  @default(0.00) @db.Decimal(10, 2)
  createdAt   DateTime @default(now()) @map("created_at")

  photos         ServicePhoto[]
  availabilities ServiceAvailability[]
  provider       ServiceProvider       @relation(fields: [providerId], references: [userId])
  providerId     String                @db.Uuid
  appointments   Appointment[]
  category       Category              @relation(fields: [categoryId], references: [id])
  categoryId     Int

  @@map("services")
}

model ServicePhoto {
  id        String @id @default(uuid()) @db.Uuid
  serviceId String @map("service_id") @db.Uuid
  photoUrl  String @map("photo_url") @db.Text

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@map("service_photos")
}

model Review {
  id         String   @id @default(uuid()) @db.Uuid
  providerId String   @map("provider_id") @db.Uuid
  clientId   String   @map("client_id") @db.Uuid
  rating     Decimal  @db.Decimal(2, 1)
  comment    String?  @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  provider ServiceProvider @relation("ProviderReviews", fields: [providerId], references: [userId], onDelete: Cascade)
  client   User            @relation("ClientReviews", fields: [clientId], references: [id], onDelete: Cascade)

  @@map("review")
}

model Contact {
  id     String      @id @default(uuid()) @db.Uuid
  userId String      @map("user_id") @db.Uuid
  type   ContactType
  value  String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("contacts")
}

model Appointment {
  id            String            @id @default(uuid()) @db.Uuid
  description   String            @db.VarChar(1000)
  scheduledAt   DateTime
  status        AppointmentStatus @default(PENDING)
  paymentMethod PaymentMethod

  serviceId String  @db.Uuid
  service   Service @relation(fields: [serviceId], references: [id])

  clientId String @db.Uuid
  client   User   @relation("ClientAppointments", fields: [clientId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("appointments")
}
